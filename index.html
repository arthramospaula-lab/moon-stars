<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lua com Estrelas (pixel-perfect)</title>
<style>
  :root {
    --moon-size: min(85vmin, 580px);
    --stars-target: 160; /* ajuste aqui quantas estrelas deseja */
  }
  html,body{height:100%;margin:0;background:#000;}
  body{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    overflow:hidden;
  }

  .moon-wrapper{
    position:relative;
    width:var(--moon-size);
    height:var(--moon-size);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* A div que mostra a lua (imagem) */
  .moon {
    position:absolute;
    inset:0;
    border-radius:50%;
    background-size:cover;
    background-position:center;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
    z-index:1;
  }

  /* canvas para desenhar as estrelas (por cima da área do céu, mas por baixo da lua visualmente)
     Nós desenhamos no canvas e ele ficará sobre a imagem; as estrelas só são posicionadas onde a imagem é escura */
  canvas.stars-canvas{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border-radius:50%;
    z-index:2;
    pointer-events:none;
  }

  /* fallback mobile small tweaks */
  @media (max-width:420px){
    :root { --moon-size: 92vmin; }
  }
</style>
</head>
<body>

<div class="moon-wrapper" id="moonWrapper">
  <div class="moon" id="moonDiv" aria-hidden="true"></div>
  <canvas class="stars-canvas" id="starsCanvas" aria-hidden="true"></canvas>
</div>

<script>
/* ----------------- CONFIG ----------------- */
/* Sua URL RAW (já configurada com a que você enviou) */
const GITHUB_RAW = "https://raw.githubusercontent.com/arthramospaula-lab/lua-repo/refs/heads/main/Moon.jpg";
/* Ajustes: número de estrelas e limiar de "escuridão" (0 a 255) */
const TARGET_STARS = Number(getComputedStyle(document.documentElement).getPropertyValue('--stars-target')) || 140;
const BRIGHTNESS_THRESHOLD = 70; // quanto menor => só muito escuro aceita. ajuste se quiser mais estrelas.
/* ------------------------------------------ */

const moonDiv = document.getElementById('moonDiv');
const wrapper = document.getElementById('moonWrapper');
const canvas = document.getElementById('starsCanvas');
const ctx = canvas.getContext('2d', { alpha: true });

/* imagem carregada do GitHub */
const img = new Image();
img.crossOrigin = "anonymous";
img.src = GITHUB_RAW;

let sampledStars = []; // {x,y,size,alpha,tDur,phase}

/* Ajusta canvas ao tamanho atual do wrapper e prepara tmpCanvas com a imagem desenhada no mesmo 'cover' scale */
function prepareCanvases(){
  const rect = wrapper.getBoundingClientRect();
  canvas.width = Math.round(rect.width);
  canvas.height = Math.round(rect.height);

  // canvas temporário para desenhar a imagem no mesmo fit cover que o background
  const tmp = document.createElement('canvas');
  tmp.width = canvas.width;
  tmp.height = canvas.height;
  const tctx = tmp.getContext('2d');

  // calcular scale cover (mesmo comportamento de background-size: cover)
  const sw = img.width, sh = img.height;
  const dw = tmp.width, dh = tmp.height;
  const scale = Math.max(dw / sw, dh / sh);
  const drawW = Math.round(sw * scale);
  const drawH = Math.round(sh * scale);
  const dx = Math.round((dw - drawW) / 2);
  const dy = Math.round((dh - drawH) / 2);

  tctx.clearRect(0,0,dw,dh);
  tctx.drawImage(img, dx, dy, drawW, drawH);

  // salvar referências
  canvas._tmpCanvas = tmp;
  canvas._tmpCtx = tctx;

  // aplicar imagem como background da div .moon (cover)
  moonDiv.style.backgroundImage = `url("${GITHUB_RAW}")`;
}

/* Gera posições de estrelas baseadas na amostragem de pixels escuros */
function generateStarsFromImage(){
  sampledStars = [];
  const tmpCtx = canvas._tmpCtx;
  if (!tmpCtx) return;

  const W = canvas.width;
  const H = canvas.height;
  let attempts = 0;
  const maxAttempts = Math.max(4000, TARGET_STARS * 40);
  let placed = 0;

  while(attempts < maxAttempts && placed < TARGET_STARS){
    attempts++;
    const x = Math.floor(Math.random() * W);
    const y = Math.floor(Math.random() * H);
    // ler pixel amostrado
    const p = tmpCtx.getImageData(x, y, 1, 1).data;
    const r = p[0], g = p[1], b = p[2], a = p[3];
    const brightness = (r + g + b) / 3;
    // queremos estrelas somente onde o pixel é ESCURO (sky), e não totalmente transparente
    if (a > 0 && brightness <= BRIGHTNESS_THRESHOLD) {
      // evitar pontos muito próximos entre si (opcional)
      let ok = true;
      for (let s of sampledStars){
        const dx = s.x - x, dy = s.y - y;
        if ((dx*dx + dy*dy) < ( (s.size*6) * (s.size*6) )) { ok = false; break; }
      }
      if (!ok) continue;

      // criar estrela
      const size = 1 + Math.random()*3.0; // 1..4 px
      const baseAlpha = 0.35 + Math.random()*0.7;
      const twDur = 1 + Math.random()*2.5;
      const phase = Math.random()*Math.PI*2;
      sampledStars.push({ x, y, size, baseAlpha, twDur, phase });
      placed++;
    }
  }
}

/* anima as estrelas */
function drawStarsFrame(time){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for (let s of sampledStars){
    const t = time/1000;
    const a = s.baseAlpha * (0.55 + 0.45 * Math.abs(Math.sin((t * (2*Math.PI / s.twDur)) + s.phase)));
    // círculo principal
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${a.toFixed(3)})`;
    ctx.arc(s.x + 0.5, s.y + 0.5, s.size/2, 0, Math.PI*2);
    ctx.fill();

    // leve brilho radial
    const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.size*2.2);
    g.addColorStop(0, `rgba(255,255,255,${(a*0.5).toFixed(3)})`);
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size*2.2, 0, Math.PI*2);
    ctx.fill();
  }
  requestAnimationFrame(drawStarsFrame);
}

/* re-gerar quando a janela muda (responsivo) */
let resizeTimer = null;
function handleResize(){
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>{
    prepareCanvases();
    generateStarsFromImage();
  }, 140);
}
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', handleResize);

/* iniciar tudo quando a imagem carregar */
img.onload = () => {
  prepareCanvases();
  generateStarsFromImage();
  requestAnimationFrame(drawStarsFrame);
};

/* fallback: caso já tenha carregado */
if (img.complete) {
  img.onload();
}
</script>

</body>
</html>
