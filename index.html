<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lua com Estrelas (anel)</title>
<style>
  :root{
    --moon-size: min(85vmin, 580px);
  }
  html,body{height:100%;margin:0;background:#000;}
  body{
    display:flex;align-items:center;justify-content:center;min-height:100vh;overflow:hidden;
    -webkit-font-smoothing:antialiased;
  }

  .moon-wrapper{
    position:relative;
    width:var(--moon-size);
    height:var(--moon-size);
    display:flex;align-items:center;justify-content:center;
  }

  .moon {
    position:absolute;inset:0;border-radius:50%;
    background-size:cover;background-position:center;
    z-index:1;
    box-shadow: inset 0 0 18px rgba(0,0,0,0.6);
  }

  canvas.stars-canvas{
    position:absolute;inset:0;width:100%;height:100%;border-radius:50%;
    z-index:2;pointer-events:none;
  }

  /* mobile tweak */
  @media (max-width:420px){ :root{--moon-size:92vmin;} }
</style>
</head>
<body>

<div class="moon-wrapper" id="moonWrapper">
  <div class="moon" id="moonDiv" aria-hidden="true"></div>
  <canvas class="stars-canvas" id="starsCanvas" aria-hidden="true"></canvas>
</div>

<script>
/* ----------------- CONFIGURAÇÕES (mude aqui se quiser) ----------------- */
/* URL da sua imagem no repo (já enviada por você) */
const GITHUB_RAW = "https://raw.githubusercontent.com/arthramospaula-lab/lua-repo/refs/heads/main/Moon.jpg";

/* quantidade moderada de estrelas (ajuste se quiser mais/menos) */
const TARGET_STARS = 64;

/* faixa de brilho dos pixels onde aceitaremos estrelas:
   - IGNORA pixels muito escuros (área totalmente preta de fora)
   - IGNORA pixels muito claros (a Lua)
   ajuste se necessário */
const MIN_BRIGHTNESS = 12;   // não pega o preto absoluto (0..255)
const MAX_BRIGHTNESS = 120;  // não pega a lua (pixels claros)

/* limites do anel (multiplicador do raio da lua) - 
   INNER_MULTIPLIER > 1 para não tocar a lua */
const INNER_MULTIPLIER = 1.06; // começa um pouco fora da borda da lua
const OUTER_MULTIPLIER = 1.22; // até onde o anel chega
/* ---------------------------------------------------------------------- */

const moonDiv = document.getElementById('moonDiv');
const wrapper = document.getElementById('moonWrapper');
const canvas = document.getElementById('starsCanvas');
const ctx = canvas.getContext('2d', { alpha: true });

const img = new Image();
img.crossOrigin = "anonymous";
img.src = GITHUB_RAW;

function prepareCanvases(){
  const rect = wrapper.getBoundingClientRect();
  canvas.width = Math.max(2, Math.round(rect.width));
  canvas.height = Math.max(2, Math.round(rect.height));

  // canvas temporário para desenhar a imagem no mesmo scale "cover"
  const tmp = document.createElement('canvas');
  tmp.width = canvas.width;
  tmp.height = canvas.height;
  const tctx = tmp.getContext('2d');

  // calcular cover fit
  const sw = img.width || 1, sh = img.height || 1;
  const dw = tmp.width, dh = tmp.height;
  const scale = Math.max(dw / sw, dh / sh);
  const drawW = Math.round(sw * scale);
  const drawH = Math.round(sh * scale);
  const dx = Math.round((dw - drawW) / 2);
  const dy = Math.round((dh - drawH) / 2);

  tctx.clearRect(0,0,dw,dh);
  tctx.drawImage(img, dx, dy, drawW, drawH);

  canvas._tmpCanvas = tmp;
  canvas._tmpCtx = tctx;

  // aplicar imagem como background da div .moon (cover)
  moonDiv.style.backgroundImage = `url("${GITHUB_RAW}")`;
}

/* brilho médio do pixel */
function pixelBrightness(p){
  return (p[0] + p[1] + p[2]) / 3;
}

/* gerar estrelas SOMENTE dentro do anel e em pixels com brilho na faixa desejada */
function generateStarsFromImage(){
  const tmpCtx = canvas._tmpCtx;
  if (!tmpCtx) return;

  const W = canvas.width;
  const H = canvas.height;
  const centerX = W/2;
  const centerY = H/2;
  const moonRadius = Math.min(W, H) / 2;

  const innerR = moonRadius * INNER_MULTIPLIER;
  const outerR = moonRadius * OUTER_MULTIPLIER;

  const sampledStars = [];
  let attempts = 0;
  const maxAttempts = Math.max(6000, TARGET_STARS * 150);
  let placed = 0;

  while(attempts < maxAttempts && placed < TARGET_STARS){
    attempts++;
    const angle = Math.random() * Math.PI * 2;
    // sorteamos um raio dentro do anel com leve bias para meio do anel
    const r = innerR + (outerR - innerR) * Math.pow(Math.random(), 0.9);
    const x = Math.floor(centerX + Math.cos(angle) * r);
    const y = Math.floor(centerY + Math.sin(angle) * r);

    if (x < 0 || x >= W || y < 0 || y >= H) continue;

    const pdata = tmpCtx.getImageData(x, y, 1, 1).data;
    if (pdata[3] === 0) continue;

    const brightness = pixelBrightness(pdata);

    // aceitar somente pixels na faixa [MIN_BRIGHTNESS, MAX_BRIGHTNESS]
    if (brightness < MIN_BRIGHTNESS || brightness > MAX_BRIGHTNESS) continue;

    // evitar aglomeração
    let ok = true;
    for (let s of sampledStars) {
      const ddx = s.x - x, ddy = s.y - y;
      if ((ddx*ddx + ddy*ddy) < ( (s.size*3) * (s.size*3) )) { ok = false; break; }
    }
    if (!ok) continue;

    const size = 0.9 + Math.random() * 2.2; // 0.9..3.1 px
    const baseAlpha = 0.28 + Math.random()*0.56;
    const twDur = 1.2 + Math.random()*2.3;
    const phase = Math.random()*Math.PI*2;
    sampledStars.push({ x, y, size, baseAlpha, twDur, phase });
    placed++;
  }

  // guardar no canvas para usar no draw
  canvas._stars = sampledStars;
}

/* desenha cada frame, com efeito de brilho suave (sin) */
function drawStarsFrame(time){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const stars = canvas._stars || [];
  for (let s of stars){
    const t = time/1000;
    const a = s.baseAlpha * (0.55 + 0.45 * Math.abs(Math.sin((t * (2*Math.PI / s.twDur)) + s.phase)));
    // ponto central
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${a.toFixed(3)})`;
    ctx.arc(s.x + 0.5, s.y + 0.5, Math.max(0.45, s.size/2), 0, Math.PI*2);
    ctx.fill();

    // brilho suave ao redor (gradiente)
    const glowRadius = s.size * 2.0;
    const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, glowRadius);
    g.addColorStop(0, `rgba(255,255,255,${(a*0.45).toFixed(3)})`);
    g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(s.x, s.y, glowRadius, 0, Math.PI*2);
    ctx.fill();
  }
  requestAnimationFrame(drawStarsFrame);
}

let resizeTimer = null;
function handleResize(){
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>{
    prepareCanvases();
    generateStarsFromImage();
  }, 140);
}
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', handleResize);

/* Quando imagem carregar, preparar e iniciar animação */
img.onload = () => {
  prepareCanvases();
  generateStarsFromImage();
  requestAnimationFrame(drawStarsFrame);
};
if (img.complete) img.onload();

/* ---------- DICA: se não aparecer, aumente MIN_BRIGHTNESS levemente (ex: 18)
   ou diminua MAX_BRIGHTNESS se estrelas invadem a lua. ---------- */
</script>
</body>
</html>
